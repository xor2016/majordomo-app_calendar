<a style="margin: 15px 0px 5px 15px;" class="btn btn-default" href="?">Назад</a>
    <style>
      .box {
      //width: 120px;
      height: 30px;
      border: 1px solid #999;
      font-size: 18px;
      //color: #1c87c9;
      //background-color: #eee;
      border-radius: 4px;
      box-shadow: 4px 4px #ccc;
      }
    </style>
<div style="margin:30px;">
<form action="?" method="post">
<table width="100%" border="0">
<tr>
<td valign="top" style="width: 0%;"></td>
<td valign="top" style="width: auto;">Название:</td>
</tr>

 <tr>
  <td></td>
  <td valign="top"><input style="width: 25%;height: 50px;font-size: 21px;" type="text" name="title" value="[#TITLE#]">
  [#if SYSTEM!=""#]<br>(<#LANG_SYSTEM_NAME#>: [#SYSTEM#])[#endif#]
  </td>
 </tr>

<tr>
<td></td>
<td valign="top" style="width: auto;">Категория:</td>
</tr>

 <td></td>
 <td valign="top">
 <select style="margin-top: 4px;width: auto;" class="box" name="calendar_category_id">
  <option value="0">Без категории
  [#begin CALENDAR_CATEGORIES#]
  <option value="[#ID#]" [#if ID="<#CALENDAR_CATEGORY_ID#>"#] selected[#endif#]>[#TITLE#]
  [#end CALENDAR_CATEGORIES#]
  </select>
 </td> 
</tr>

 <tr>
  <td></td>
  <td valign="top">
   <label style="padding-bottom:30px;"><input type="radio" name="is_task" id="is_event" value="0"[#if IS_TASK!="1"#] checked[#endif#] data-role="none"> Событие</label>
   &nbsp;&nbsp;
   <label><input type="radio" name="is_task" id="is_task" value="1"[#if IS_TASK="1"#] checked[#endif#] data-role="none"> Задача</label>
   <span id="task_done_block"[#if IS_TASK!="1"#] style="display:none"[#endif#]>
   <label><input type="checkbox" name="is_done" value="1"[#if IS_DONE="1"#] checked[#endif#] data-role="none"> Готово</label>
   </span>
   <span id="autodone_block"[#if IS_NODATE="1" || IS_TASK!="1"#] style="display:none"[#endif#]> 
   <input type="checkbox" name="autodone" value="1"[#if AUTODONE="1"#] checked[#endif#] data-role="none"> Автозавершение по сроку</span>
  </td>
 </tr>
<tr>
<td></td>
<td valign="top" style="width: auto;">Срок:</td>
</tr>
 <tr>
  <td></td>
  <td>
  <label><input type="checkbox" name="is_nodate" id="is_nodate" value="1"[#if IS_NODATE="1"#] checked[#endif#] data-role="none"> Без срока</label>
  <span id="show_date"[#if IS_NODATE="1"#] style="display:none"[#endif#]>
  <label><input type="checkbox" name="all_day" id="all_day" value="1"[#if ALL_DAY="1"#] checked[#endif#] data-role="none"> Весь день</label>
  <label><input type="checkbox" name="is_repeating" id="is_repeating" value="1"[#if IS_REPEATING="1"#] checked[#endif#] data-role="none"> С повторами</label></span>
  </td>

 </tr>

<tr>
<td></td>
<td>
<input type="hidden" id="due" name="due" value="[#DUE#]" />
<input type="hidden" id="end_time" name="end_time" value="[#END_TIME#]" />
<div class="datetimepickers" id="dtps" [#if ALL_DAY="0" && IS_NODATE="0"#] style="display:block"[#else#] style="display:none"[#endif#]>
  <div class="col-xs-2">
        <div class="form-group">
            <div class="input-group date" id="st_time">
                <input type="text" class="form-control"/>
                <span class="input-group-addon">
                    <i class="glyphicon glyphicon-calendar"></i>
                </span>
            </div>
       </div>
  </div>
  <div class="col-xs-2">
            <div class="input-group date" id="en_time">
                <input type="text" class="form-control"/>
                <span class="input-group-addon">
                    <i class="glyphicon glyphicon-calendar"></i>
                </span>
            </div>
  </div>
</div>
<script type="text/javascript">
    $(function () {
        // инициализация 
        $("#en_time").datetimepicker({
            locale: "ru",sideBySide:true, useCurrent: false, minDate: "[#DUE#]", defaultDate: "[#END_TIME#]"
        });
        $("#st_time").datetimepicker({
          locale: "ru",sideBySide:true, defaultDate: "[#DUE#]"
        });
        $("#st_time").on("dp.change", function (e) {
            
            document.getElementById('due').value = moment(e.date).format('YYYY-MM-DD HH:mm:ss');
            //
            if(e.date>$('#en_time').data("DateTimePicker").date()){
              $('#en_time').data("DateTimePicker").date(e.date);
            }
            //check remind time only for absolut time         
            if(e.date<$('#dps_remind').data("DateTimePicker").date()){
              $('#dps_remind').data("DateTimePicker").date(e.date);
              $('#dps_remind').data("DateTimePicker").maxDate($('#en_time').data("DateTimePicker").date());//max time for remind
            }
            //установим минимум выбора даты конца 
            $('#en_time').data("DateTimePicker").minDate(e.date);
        });
        $("#en_time").on("dp.change", function (e) {
           document.getElementById('end_time').value = moment(e.date).format('YYYY-MM-DD HH:mm:ss');
           if(e.date<$('#dps_remind').data("DateTimePicker").date()){
              $('#dps_remind').data("DateTimePicker").date(e.date);
              $('#dps_remind').data("DateTimePicker").maxDate(e.date);//max time for remind
            }
        });
    });
</script>
</td>
 </tr>
<tr>
<td>
</td>
<td>
<div class="datepickers" id="dps" [#if ALL_DAY="1" && IS_NODATE="0"#] style="display:block"[#else#] style="display:none"[#endif#]>
  <div class="col-xs-2">
        <div class="form-group">
            <div class="input-group date" id="st_time1">
                <input type="text" class="form-control"/>
                <span class="input-group-addon">
                    <i class="glyphicon glyphicon-calendar"></i>
                </span>
            </div>
       </div>
  </div>
  <div class="col-xs-2">
            <div class="input-group date" id="en_time1">
                <input type="text" class="form-control"/>
                <span class="input-group-addon">
                    <i class="glyphicon glyphicon-calendar"></i>
                </span>
            </div>
  </div>
</div>
<script type="text/javascript">
    $(function () {
        // инициализация 
        $("#en_time1").datetimepicker({
            locale: "ru", useCurrent: false, minDate: moment("[#DUE#]","YYYY-MM-DD HH:mm:ss"), defaultDate: moment("[#END_TIME#]","YYYY-MM-DD HH:mm:ss"),format: "DD.MM.YYYY"
        });
        $("#st_time1").datetimepicker({
          locale: "ru", defaultDate: moment("[#DUE#]","YYYY-MM-DD HH:mm:ss"),format: "DD.MM.YYYY"
        });
        $("#st_time1").on("dp.change", function (e) {
            
            document.getElementById('due').value = moment(e.date).format('YYYY-MM-DD HH:mm:ss');
       
            if(e.date>$('#en_time1').data("DateTimePicker").date()){
              $('#en_time1').data("DateTimePicker").date(e.date);
            }
            //check remind time          
            if(e.date<$('#dps_remind').data("DateTimePicker").date()){
              $('#dps_remind').data("DateTimePicker").date(e.date);
              $('#dps_remind').data("DateTimePicker").maxDate($('#en_time1').data("DateTimePicker").date());//max time for remind
            }
            //установим минимум выбора даты конца 
            $('#en_time1').data("DateTimePicker").minDate(e.date);
            

        });
        $("#en_time1").on("dp.change", function (e) {
           document.getElementById('end_time').value = moment(e.date).format('YYYY-MM-DD HH:mm:ss');
           if(e.date<$('#dps_remind').data("DateTimePicker").date()){
              $('#dps_remind').data("DateTimePicker").date(e.date);
              $('#dps_remind').data("DateTimePicker").maxDate(e.date);//max time for remind
        });
    });
</script>

</td>
</tr>
<tr>
<td valign="top">
</td>
  <td valign="top">
<div id="repeat_type_block"[#if IS_REPEATING!="1"#] style="display:none"[#endif#]>
   <span id="every_lbl" style="font-size:18px">Повторять [#if REPEAT_TYPE="6"#]каждую[#else#] каждый[#endif#]</span>
   <input type="text" size="1" class="box" name="repeat_in" value="[#REPEAT_IN#][#if REPEAT_IN=""#]1[#endif#]">
   <select style="width: auto;" class="box" name="repeat_type" id="repeat_type" data-role="none">
    <option value="1"[#if REPEAT_TYPE="1"#] selected[#endif#]>год
    <option value="2"[#if REPEAT_TYPE="2"#] selected[#endif#]>месяц
    <option value="3"[#if REPEAT_TYPE="3"#] selected[#endif#]>день недели
    <option value="4"[#if REPEAT_TYPE="4"#] selected[#endif#]>день
    <option value="5"[#if REPEAT_TYPE="5"#] selected[#endif#]>час
    <option value="6"[#if REPEAT_TYPE="6"#] selected[#endif#]>минуту
   </select>

  <div id="restore_weekly_block" [#if REPEAT_TYPE!="3"#] style="display:none"[#endif#]>
[#begin WDAYS#]
 			<input type="checkbox" name="week_days[]" value="[#VALUE#]"[#if SELECTED="1"#] checked[#endif#]>[#DNAME#] 
[#end WDAYS#]
  </div>
</div>
</td>
</tr>
<tr>
<td></td>
<td valign="top" style="width: auto;">&nbsp;</td>
</tr>
<tr>
  <td></td>
  <td valign="top">
  <label><input type="checkbox" name="is_remind" id="is_remind" value="1" [#if IS_REMIND="1"#] checked[#endif#] data-role="none">Напомнить</label>
  </td>
</tr>

<tr>
<td colspan="2">
<div id="remind_details" style="width: 100%; [#if IS_REMIND!="1"#]display:none[#endif#]">
<table width="100%" border="0">

<tr>
 <td valign="top" style="width: 0%;"></td>
 <td>
 <div>

   <select name="remind_timer" id="remind_timer" class="box">
    <option value="0"[#if REMIND_TIMER="0"#] selected[#endif#]>за 5 минут
    <option value="1"[#if REMIND_TIMER="1"#] selected[#endif#]>за 15 минут
    <option value="2"[#if REMIND_TIMER="2"#] selected[#endif#]>за 30 минут
    <option value="3"[#if REMIND_TIMER="3"#] selected[#endif#]>за 45 минут
    <option value="4"[#if REMIND_TIMER="4"#] selected[#endif#]>за 1 час
    <option value="5"[#if REMIND_TIMER="5"#] selected[#endif#]>за 2 часа
    <option value="6"[#if REMIND_TIMER="6"#] selected[#endif#]>за 8 часов
    <option value="7"[#if REMIND_TIMER="7"#] selected[#endif#]>за 12 часов
    <option value="8"[#if REMIND_TIMER="8"#] selected[#endif#]>за 1 день
    <option value="9"[#if REMIND_TIMER="9"#] selected[#endif#]>за 2 дня
    <option value="10"[#if REMIND_TIMER="10"#] selected[#endif#]>в назначенное время
   </select>
</div> 
 </td>
</tr>
<tr><td></td></tr>
<td></td>
<td>
<input type="hidden" class="form-control" id="remind_time" name="remind_time" value="[#REMIND_TIME#]">
<div class="col-xs-2" id="dps_remind_block" [#if REMIND_TIMER="10"#] style="display:block"[#else#] style="display:none"[#endif#]> 
        <div class="form-group">
            <div class="input-group date" id="dps_remind">
                <input type="text" class="form-control"/>
                <span class="input-group-addon">
                    <i class="glyphicon glyphicon-calendar"></i>
                </span>
            </div>
       </div>
</div>
<script type="text/javascript">
    $(function () {
        // инициализация 
        $("#dps_remind").datetimepicker({
            locale: "ru" ,sideBySide:true, defaultDate: moment(document.getElementById('remind_time').value,"YYYY-MM-DD HH:mm:ss"),maxDate: moment(document.getElementById('due').value,"YYYY-MM-DD HH:mm:ss")
        });
        $("#dps_remind").on("dp.change", function (e) {
           document.getElementById('remind_time').value = moment(e.date).format('YYYY-MM-DD HH:mm:ss');
        });
    });
</script>

</td>
</tr>
<tr>
<td></td>
 <td>
  <label><input type="radio" name="remind_type" id="sayto" value="0" [#if REMIND_TYPE="0"#] checked[#endif#] data-role="none"> Сказать</label>
  <label><input type="radio" name="remind_type" id="docode" value="1"[#if REMIND_TYPE="1"#] checked[#endif#] data-role="none"> Выполнить код</label>
 </td>
</tr>
<tr>
<td></td>
<td valign="top" style="width: auto;">
<span id="remind_code_block"[#if REMIND_TYPE!="1"#] style="display:none"[#endif#]>
<textarea style="width: auto;" class="form-control" id="remind_code" name="remind_code" cols="40" rows="4">[#REMIND_CODE#]</textarea>
</span>
</td>

</tr>
</table>
</div>
</td>
</tr>

<tr>
  <td></td>
  <td valign="top">
   <label class="box" name="advanced" id="advanced" onClick="toggle_show('advanced_details')"> &nbsp;&nbsp;Детали&nbsp;&nbsp;</label>
  </td>
</tr>

<tr>
<td colspan="2">
<div id="advanced_details" style="width: 100%;display:none">
<table width="100%" border="0">
<tr>
<td></td>
<td>Заметки:</td>
</tr>
 <tr>
  <td></td>
  <td valign="top" style="width: auto;">
  <textarea style="width: auto;" class="form-control" name="notes" cols="40" rows="3">[#NOTES#]</textarea>
</td>
</tr>
<tr>
<td></td>
<td>Пользователь:</td>
</tr>
<tr>
  <td></td>
  <td valign="top">
  <select style="width: auto;" class="box" name="user_id">
   <option value="0">Любой
   [#begin USERS#]
   <option value="[#ID#]"[#if ID="<#USER_ID#>"#] selected[#endif#]>[#NAME#]
   [#end USERS#]
  </select>
  </td>
 </tr>
<tr>
<td></td>
<td><#LANG_RUN_SCRIPT#>:</td>
</tr>
 <tr>
  <td></td>
  <td>
   <select style="width: auto;" class="box" name="done_script_id">
    <option value="0">
    [#begin SCRIPTS#]
    <option value="[#ID#]"[#if ID="<#DONE_SCRIPT_ID#>"#] selected[#endif#]>[#TITLE#]
    [#end SCRIPTS#]
   </select>
   (<#LANG_WHEN_TASK_WILL_BE_DONE#>)
  </td>
 </tr>
<tr>
<td></td>
<td>Выполнить код:</td>
</tr>
 <tr>
  <td></td>
  <td valign="top" style="width: auto;">
  <textarea style="width: auto;" class="form-control" name="done_code" cols="40" rows="3">[#DONE_CODE#]</textarea>
</td>
 </tr>
</table>
</div>
</td>
</tr>

<tr>
  <td valign="top"></td>
  <td valign="top">
  <label class="box" name="hierarchy" id="hierarchy" onClick="toggle_show('hierarchy_details')"> &nbsp;&nbsp;Иерархия&nbsp;&nbsp;</label>
  </td>
</tr>
<tr> 
<td colspan="2">
<div id="hierarchy_details" style="width: 100%;display:none">
<table width="100%" border="0">
<tr>
<td>Главная задача:</td>
</tr>
 <tr>
  <td valign="top" style="width: auto;">
 
   <select style="width: auto;" class="box" name="parent_id">
    <option value="0">нет главной задачи
    [#begin FOR_LINKED_TASKS#]
    <option value="[#ID#]"[#if ID="<#PARENT_ID#>"#] selected[#endif#]>&nbsp;&nbsp;[#TITLE#]
    [#end FOR_LINKED_TASKS#]
   </select>

</td>
</tr>
<tr>
<td></td>
</tr>
<tr>
 <td valign="top">
  <label><input type="checkbox" name="autodone_by_childs" id="autodone_by_childs" value="1" [#if AUTODONE_BY_CHILDS="1"#] checked[#endif#] data-role="none"> Готово при завершении всех подчиненных</label>
</tr>
<tr>
<td>
</td>
</tr>
 [#if OTHERS_REC_COUNT>0#]
 [#begin OTHERS#]
<tr>
  <td valign="top" style="width: 20%;">
 [#if IS_DONE="1"#]<strike>[#endif#][#TITLE#][#if IS_DONE="1"#]</strike>[#endif#]</td><td><a href="?view_mode=edit&id=[#ID#]"><img style="height: 20px;" src="../cms/calendar/settings.png" /></a>
</td>
</tr>
[#end OTHERS#]
[#endif#]
</table>
</div>
</td>
</tr>

 <tr>
  <td></td>
  <td valign="top"><input style="margin-top: 20px;" class="btn btn-default" type="submit" name="submit" value="<#LANG_SUBMIT#>">
  <a style="margin-top: 20px;" class="btn btn-default" href="?"><#LANG_CANCEL#></a>
  [#if ID!=""#]
   <a style="margin-top: 20px;" class="btn btn-default" href="?view_mode=<#VIEW_MODE#>&id=<#ID#>&mode=delete" onClick="return confirm('<#LANG_ARE_YOU_SURE#>');"><#LANG_DELETE#></a>
  [#endif ID#]
  </td>
 </tr>
 <input type="hidden" name="view_mode" value="<#VIEW_MODE#>">
 <input type="hidden" name="mode" value="update">
 <input type="hidden" name="id" value="<#ID#>">
</table>
</form>
</div>
&nbsp;


<script language="javascript">

 $('#is_task').click (function ()
  {
  var thisCheck = $(this);
	  if (thisCheck.is(':checked')) {
	   $('#task_done_block').show();
	   $('#autodone_block').show();
	  } else {
	   $('#task_done_block').hide();
	   $('#autodone_block').hide();
	  }
 });

 $('#is_event').click (function ()
  {
  var thisCheck = $(this);
	  if (thisCheck.is(':checked')) {
	   $('#task_done_block').hide();
	   $('#autodone_block').hide();
	  } else {
	   $('#task_done_block').show();
	   $('#autodone_block').show();
	  }
 });

 $('#is_nodate').click (function ()
  {
  var thisCheck = $(this);
  if (thisCheck.is(':checked')) {
   $('#show_date').hide();
   $('#autodone_block').hide();
   document.getElementById("dps").style.display="none";
   document.getElementById("dtps").style.display="none"; 
   $('#repeat_type_block').hide();
//цикл todo
   $('#remind_timer option[value=0]').hide();
   $('#remind_timer option[value=1]').hide();
   $('#remind_timer option[value=2]').hide();
   $('#remind_timer option[value=3]').hide();
   $('#remind_timer option[value=4]').hide();
   $('#remind_timer option[value=5]').hide();
   $('#remind_timer option[value=6]').hide();
   $('#remind_timer option[value=7]').hide();
   $('#remind_timer option[value=8]').hide();
   $('#remind_timer option[value=9]').hide();
   document.getElementById('remind_timer').value = 10;
   $('#dps_remind_block').show();
  } else {
   $('#remind_timer option[value=0]').show();
   $('#remind_timer option[value=1]').show();
   $('#remind_timer option[value=2]').show();
   $('#remind_timer option[value=3]').show();
   $('#remind_timer option[value=4]').show();
   $('#remind_timer option[value=5]').show();
   $('#remind_timer option[value=6]').show();
   $('#remind_timer option[value=7]').show();
   $('#remind_timer option[value=8]').show();
   $('#remind_timer option[value=9]').show();
   $('#show_date').show();
   $('#autodone_block').show();
	   if(document.getElementById("all_day").checked){
		document.getElementById("dps").style.display="block";
	    document.getElementById("dtps").style.display="none";
	   }else{
		document.getElementById("dps").style.display="none";
	    document.getElementById("dtps").style.display="block";   
	   }
	   if(document.getElementById("is_repeating").checked){
	    $('#repeat_type_block').show();
	   }else{
	    $('#repeat_type_block').hide();
	   }
 }
});

 $('#all_day').click (function ()
  {
  var thisCheck = $(this);
	  if (thisCheck.is(':checked')) {
		document.getElementById("dps").style.display="block";
	    document.getElementById("dtps").style.display="none";
	  } else {
		document.getElementById("dps").style.display="none";
	    document.getElementById("dtps").style.display="block";
	 }
 });


 $('#is_repeating').click (function ()
  {
  var thisCheck = $(this);
	  if (thisCheck.is(':checked')) {
	   $('#repeat_type_block').show();
	  } else {
	   $('#repeat_type_block').hide();
	  }
 });

 $('#repeat_type').change (function ()
  {
  var thisCheck = $(this);
	  if (thisCheck.val()=='3') {
	   $('#restore_weekly_block').show();
	  } else {
	   $('#restore_weekly_block').hide();
	  }

      if (thisCheck.val()=='6') {//для минут
	   document.getElementById("every_lbl").textContent="Повторять каждую ";
	  } else {
	   document.getElementById("every_lbl").textContent="Повторять каждый ";
	  }
 });

 $('#is_remind').click (function ()
  {
  var thisCheck = $(this);
	  if (thisCheck.is(':checked')) {
	   $('#remind_details').show();
       if (document.getElementById('is_nodate').checked){
		   $('#remind_timer option[value=0]').hide();
		   $('#remind_timer option[value=1]').hide();
		   $('#remind_timer option[value=2]').hide();
		   $('#remind_timer option[value=3]').hide();
		   $('#remind_timer option[value=4]').hide();
		   $('#remind_timer option[value=5]').hide();
		   $('#remind_timer option[value=6]').hide();
		   $('#remind_timer option[value=7]').hide();
		   $('#remind_timer option[value=8]').hide();
		   $('#remind_timer option[value=9]').hide();
	       document.getElementById('remind_timer').value = 10;
           $('#dps_remind_block').show();
        }else{
		   $('#remind_timer option[value=0]').show();
		   $('#remind_timer option[value=1]').show();
		   $('#remind_timer option[value=2]').show();
		   $('#remind_timer option[value=3]').show();
		   $('#remind_timer option[value=4]').show();
		   $('#remind_timer option[value=5]').show();
		   $('#remind_timer option[value=6]').show();
		   $('#remind_timer option[value=7]').show();
		   $('#remind_timer option[value=8]').show();
		   $('#remind_timer option[value=9]').show();
        }
	  } else {
	   $('#remind_details').hide();
	  }
 });
 $('#remind_timer').change (function ()
  {
  var thisCheck = $(this);
	  if (thisCheck.val()=='10') {
	  // $('#remind_before_block').hide();
       $('#dps_remind_block').show();
	  } else {
	   //$('#remind_before_block').show();
       $('#dps_remind_block').hide();
	  }
 });

 $('#docode').click (function ()
  {
  var thisCheck = $(this);
	  if (thisCheck.is(':checked')) {
	   $('#remind_code_block').show();
	  } else {
	   $('#remind_code_block').hide();
	  }
 });
 $('#sayto').click (function ()
  {
  var thisCheck = $(this);
	  if (thisCheck.is(':checked')) {
	   $('#remind_code_block').hide();
	  } else {
	   $('#remind_code_block').show();
	  }
 });

function toggle_show(id) {
	document.getElementById(id).style.display = document.getElementById(id).style.display == 'none' ? 'block' : 'none';
};
</script>